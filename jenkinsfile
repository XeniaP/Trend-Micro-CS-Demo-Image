pipeline {
agent any
 stages {
   stage('---Clean---') {
     steps {
       // ---Clean---
       bat 'mvn clean'
     }
   }
   stage('---Build---') {
     steps {
       // ---Build Package---
       bat 'mvn package'
     }
   }
   stage('---Veracode---') {
     steps {
     // upload and scan
     withCredentials([usernamePassword(credentialsId: 'VID', passwordVariable: 'veracode_key', usernameVariable: 'veracode_id')]) {veracode applicationName: 'verademo', canFailJob: true, criticality: 'High', debug: true, fileNamePattern: '', replacementPattern: '', sandboxName: '', scanExcludesPattern: '', scanIncludesPattern: '', scanName: '$timestamp', teams: '', uploadExcludesPattern: '', uploadIncludesPattern: '**/**.jar', useIDkey: true, vid: 'a84af2c78b38bd02e8edc2d04c9ad53d', vkey:'1b2e35da762650ca5283aa4591484d2ad15fa4625bdc1cdba8728da21cc09b672b26d012eb3f9ecc0556d6483ef05ed70c3e282a1d4fbf1e58a7f730ca0eda07', vpassword: '', vuser: ''
       }
     }
   }
   stage('Checkout') {
     steps {
       git 'https://github.com/XeniaP/scExample.git'
     }
   }
   stage('Docker build') {
     steps {
       script {
         docker.build('test/apachestruts')
       }
     }
   }
   stage('ECR push') {
     steps {
       script {
         docker.withRegistry('https://786395520305.dkr.ecr.us-west-2.amazonaws.com/', 'ecr:us-west-2:xenia-ecr') {
           docker.image('test/apachestruts').push()}
         }

       }
     }
     stage('Smartcheck') {
       steps {
         script {
           $FLAG = sh([ script: 'python scAPI.py', returnStdout: true ]).trim()
           if ($FLAG == '1') {
             sh 'docker tag test/keyfinding 786395520305.dkr.ecr.us-west-2.amazonaws.com/test/keyfinding'
             docker.withRegistry('https://786395520305.dkr.ecr.us-west-2.amazonws.com', 'ecr:us-west-2:xenia-ecr') {
               docker.image('786395520305.dkr.ecr.us-west-2.amazonaws.com/test/keyfinding').push(env.IMAGETAG+'-'+env.BUILD_ID) }
             }
               sh 'docker rmi $(docker images -q) -f 2> /dev/null'
             }

           }
         }
       }
       environment {
         IMAGETAG = 'tomcat'
         HIGH = '1'
         MEDIUM = '5'
         LOW = '5'
         NEGLIGIBLE = '5'
         UNKNOWN = '5'
         USER = 'administrator'
         PASSWORD = 'Trendmicr0!'
       }
     }
